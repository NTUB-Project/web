<div class="gmapcontent">

  <p id="notice"><%= notice %></p>
  <h1>尋找附近</h1>
  <div class="container">
  <div class="row">
    <div class="col-sm-12 col-lg-6">
      <div id="map" style="width:100%;height:600px">地圖預留</div>
    </div>

    <div class="col-sm-12 col-lg-6">
      <div class="row">
        <% @products.each do |product| %>
        <div class="col-6" style="margin-bottom: 20px">
          <div class="nearly">
            <div class="gmap-images">
            	<div class="lg-img gmap-image" style="background-image:url(<%= product.images_urls[0] %>)"></div>
            </div>
            <h5><%= product.name %></h5>
            <p>性質：<%= product.item %></p>
            <p>地址：<%= product.location %></p>
            <p>電話：<%= product.tel %></p>
          </div>
        </div>
        <% end %>
      </div>

    </div>
  </div>
  </div>

</div>



<script type="text/javascript">
function initMap() {
  if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        var pos = [{
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            picture: {
              url: "https://png.icons8.com/ios/36/0F8A71/marker-filled.png",
              width:  36,
              height: 36
            },
            infowindow: "目前位置"
        }];

        var mark = <%=raw @hash.to_json%>

        var locations = pos.concat(mark);

        var latlng = new google.maps.LatLng(locations[0].lat, locations[0].lng);
            mapOptions = {
              zoom: 11,
              center: latlng
            }
        var map = new google.maps.Map(document.getElementById('map'), mapOptions);

        var infowindow = new google.maps.InfoWindow();

        for (i = 0; i < locations.length; i++) {
            var icon = '';
            var marker = new google.maps.Marker({
                position: new google.maps.LatLng(locations[i].lat, locations[i].lng),
                map: map,
                title: locations[i].infowindow,
                icon: locations[i].picture
            });

            var contentString = marker.title;
            var infowindow = new google.maps.InfoWindow({
                content: contentString,
                maxWidth: 160
            });
            infowindow.open(map, marker);


            google.maps.event.addListener(map, 'click', (function(infowindow) {
              return function() {
                infowindow.close();
              }
            })(infowindow));

            google.maps.event.addListener(marker, 'click', (function(marker, i) {
              return function() {
                google.maps.event.trigger(map, 'click')
                var contentString = marker.title;
                infowindow.setContent(contentString);
                infowindow.open(map, marker);
              }
            })(marker, i));
        }
      });
  } else {
    alert("未允許或遭遇錯誤！");
  }
}
google.maps.event.addDomListener(window, 'load', initMap);
</script>
